<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8" />
    <title>Home - TrashFlow</title>
    <link rel="stylesheet" href="public/css/cadastroempresa.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <style>

    </style>
</head>

<body>
    <header>
        <div class="logo">
            <img src="./public/TrashflowLogo 2.png" alt="logo" />
        </div>
        <div class="navbar">
            <ul>
                <li>Quem somos</li>
                <li>Ideias de Reciclagem</li>
                <li>Empresas cadastradas</li>
                <li>Contato</li>
            </ul>
        </div>
        <div class="user-menu-container">
            <div class="user-icon-wrapper">
                <svg width="56" height="56" viewBox="0 0 36 36" fill="#4a9c0d" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M29.3,33.8h-2,0s-20.6,0-20.6,0c-1.4,0-2.6-.5-3.5-1.5-.8-.9-1.1-2.1-1-3.3l.2-1.3c.3-1.9,2-3.4,4.3-4l11.4-1.9h0s10.9,1.9,10.9,1.9c2.5.6,4,2,4.4,3.9l.2,1.3c.2,1.2-.2,2.4-1,3.3-.8,1-2.1,1.5-3.5,1.5ZM18,23.2l-10.9,1.9c-1.3.3-2.9,1.2-3.1,2.7l-.2,1.3c-.1.8.1,1.5.6,2.1.6.6,1.4,1,2.4,1h22.9c.8,0,1.5-.4,2-1,.5-.6.7-1.3.6-2.1l-.2-1.3c-.3-1.8-2.3-2.5-3.2-2.7l-10.9-1.9ZM18,18.8c-2.2,0-4.3-.9-5.8-2.4s-2.4-3.6-2.4-5.8.9-4.3,2.4-5.8c1.6-1.6,3.6-2.4,5.8-2.4s4.3.9,5.8,2.4c1.6,1.6,2.4,3.6,2.4,5.8s-.9,4.3-2.4,5.8c-1.6,1.6-3.6,2.4-5.8,2.4ZM18,3.8c-1.8,0-3.5.7-4.8,2-1.3,1.3-2,3-2,4.8s.7,3.5,2,4.8,3,2,4.8,2,3.5-.7,4.8-2c1.3-1.3,2-3,2-4.8s-.7-3.5-2-4.8c-1.3-1.3-3-2-4.8-2Z" />
                </svg>
            </div>
            <div class="user-dropdown">
                <div class="dropdown-item" data-action="login">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Entrar</span>
                </div>
                <div class="dropdown-item" data-action="cadastro">
                    <i class="fas fa-user-plus"></i>
                    <span>Cadastrar</span>
                </div>
                <div class="dropdown-item" data-action="perfil">
                    <i class="fas fa-user"></i>
                    <span>Meu perfil</span>
                </div>
                <div class="dropdown-item" data-action="logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Deslogar</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <button class="add-idea-btn" style="position: relative;
    /* right: 0px; */
    left: 900px;
    top: 40px;">
            Quero cadastrar empresa referência <i class="fas fa-plus"> </i>
        </button>
        <h1>Localização de empresas</h1>

        <div id="empresas-container"></div>

    </main>
    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <img src="./public/TrashflowLogo 2.png" alt="Trashflow Logo" width="100">
                <p>Transformando resíduos em oportunidades desde 2020.</p>
            </div>
            <div class="footer-links">
                <h4>Links Rápidos</h4>
                <ul>
                    <li><a href="#">Quem somos</a></li>
                    <li><a href="#">Ideias de Reciclagem</a></li>
                    <li><a href="#">Empresas cadastradas</a></li>
                    <li><a href="#">Contato</a></li>
                </ul>
            </div>
            <div class="footer-contact">
                <h4>Contato</h4>
                <p>contato@trashflow.com.br</p>
                <p>(11) 98765-4321</p>
                <div class="social-icons">
                    <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/124/124010.png" alt="Facebook"
                            width="24"></a>
                    <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/733/733579.png" alt="Twitter"
                            width="24"></a>
                    <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/2111/2111463.png" alt="Instagram"
                            width="24"></a>
                    <a href="#"><img src="https://cdn-icons-png.flaticon.com/512/174/174857.png" alt="LinkedIn"
                            width="24"></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2023 Trashflow. Todos os direitos reservados.</p>
        </div>
    </footer>
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Script para consumir API e montar os cards + mapas -->
    <script>
        const userIcon = document.querySelector('.user-icon-wrapper');
        const userDropdown = document.querySelector('.user-dropdown');

        // Abrir/fechar dropdown
        userIcon.addEventListener('click', function (e) {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function () {
            userDropdown.classList.remove('active');
        });

        // Prevenir fechamento ao clicar dentro do dropdown
        userDropdown.addEventListener('click', function (e) {
            e.stopPropagation();
        });

        // Ações do dropdown
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', async function () {
                const action = this.getAttribute('data-action');

                if (action === "login") {
                    window.location.href = "/login";
                } else if (action === "cadastro") {
                    window.location.href = "/cadastrar";
                } else if (action === "logout") {
                    window.location.href = "/logout";
                } else if (action === "perfil") {
                    try {
                        const resposta = await fetch('/obterusuario');
                        if (resposta.ok) {
                            window.location.href = "/perfil";
                        } else {
                            window.location.href = "/login";
                        }
                    } catch (erro) {
                        console.error("Erro ao verificar autenticação:", erro);
                        window.location.href = "/login";
                    }
                }

                // Fechar dropdown após seleção
                userDropdown.classList.remove('active');
            });
        })
        const listItems = document.getElementsByTagName('li');

        for (let i = 0; i < listItems.length; i++) {
            listItems[i].addEventListener('click', function (event) {
                const text = event.target.textContent;

                console.log(text);

                if (text === "Quem somos") {
                    window.location.href = "/sobre";
                } else if (text === "Ideias de Reciclagem") {
                    window.location.href = "/cadastroideia";
                } else if (text === "Empresas cadastradas") {
                    window.location.href = "/cadastroempresa";
                } else if (text === "Contato") {
                    window.location.href = "/contato";
                }
            });
        }
        document.querySelector('.logo').addEventListener('click', () => {
            window.location.href = "/";
        })


        async function carregarEmpresas() {
            try {
                const response = await fetch("http://localhost:3030/dataempresa");
                const empresas = await response.json();

                const container = document.getElementById("empresas-container");

                empresas.forEach((empresa, index) => {
                    const div = document.createElement("div");
                    div.classList.add("main");

                    div.innerHTML = `
            <div class="empresa">
              <h2>${empresa.nome}</h2>
              <div class="card">
                <ul class="lista">
                  <li>
                    <img src="./public/simbolo-de-reciclagem 1.png" alt=""> Materiais aceitos: ${empresa.material}
                  </li>
                  <li>
                    <img src="./public/mapas-e-bandeiras 1.png" alt=""> ${empresa.endereco}
                  </li>
                  <li>
                    <img src="./public/telefone 1.png" alt=""> ${empresa.telefone || "Não informado"}
                  </li>
                  <li>
                    <img src="./public/e-mail 1.png" alt=""> E-mail não disponível
                  </li>
                  <li>
                    <img src="./public/simbolo-de-ferramentas-de-organizacao-e-administracao-de-horario-de-calendario-e-relogio 1.png"
                        alt=""> Horário de funcionamento: ${empresa.horario_funcionamento || "Não informado"}
                  </li>
                </ul>
                <div class="mapa" id="map-${index}"></div>
              </div>
            </div>
          `;

                    container.appendChild(div);

                    // Inicializar mapa Leaflet
                    const map = L.map(`map-${index}`).setView([empresa.latitude, empresa.longitude], 16);

                    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
                        attribution: '© OpenStreetMap contributors',
                    }).addTo(map);

                    L.marker([empresa.latitude, empresa.longitude])
                        .addTo(map)
                        .bindPopup(`<strong>${empresa.nome}</strong>`)
                        .openPopup();
                });
            } catch (error) {
                console.error("Erro ao carregar empresas:", error);
            }
        }
        function getCookie(nome) {
            const value = `; ${document.cookie}`;
            const parts = value.split(`; ${nome}=`);
            if (parts.length === 2) return parts.pop().split(';').shift();
        }

        // Botão para adicionar nova ideia


        carregarEmpresas();

        carregarEmpresas();

        // Função para verificar se o usuário está logado
        async function verificarLogin() {
            try {
                const resposta = await fetch('/obterusuario');
                if (resposta.ok) {
                    return true; // Usuário logado
                } else {
                    return false; // Usuário não logado
                }
            } catch (erro) {
                console.error("Erro ao verificar login:", erro);
                return false;
            }
        }

        // Evento do botão "Quero cadastrar empresa referência"
        const addButton = document.querySelector('.add-idea-btn');
        addButton.addEventListener('click', async () => {
            const logado = await verificarLogin();

            if (logado) {
                window.location.href = "/cadastroempresaform";
            } else {
                window.location.href = "/cadastrar";
            }
        });

    </script>
</body>

</html>