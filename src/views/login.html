<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <title>Home - TrashFlow</title>
    <link rel="stylesheet" href="public/css/login.css">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        .cont {
            text-align: center;
            margin-top: 15px;
            color: #6c757d;
            cursor: pointer;
            font-size: 22px;
            position: relative;
            top: 30px;
        }

        .input-error {
            border: 2px solid red;
            animation: shake 0.3s;
        }

        @keyframes shake {
            0% {
                transform: translateX(0);
            }

            25% {
                transform: translateX(-5px);
            }

            50% {
                transform: translateX(5px);
            }

            75% {
                transform: translateX(-5px);
            }

            100% {
                transform: translateX(0);
            }
        }
    </style>
</head>

<body>
    <header>
        <div class="logo">
            <img src="./public/TrashflowLogo 2.png" alt="">
        </div>
        <div class="navbar">
            <ul>
                <li>Quem somos</li>
                <li>Ideias de Reciclagem</li>
                <li>Empresas cadastradas</li>
                <li>Contato</li>
            </ul>
        </div>

        <div class="user-menu-container">
            <div class="user-icon-wrapper">
                <svg width="56" height="56" viewBox="0 0 36 36" fill="#4a9c0d" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M29.3,33.8h-2,0s-20.6,0-20.6,0c-1.4,0-2.6-.5-3.5-1.5-.8-.9-1.1-2.1-1-3.3l.2-1.3c.3-1.9,2-3.4,4.3-4l11.4-1.9h0s10.9,1.9,10.9,1.9c2.5.6,4,2,4.4,3.9l.2,1.3c.2,1.2-.2,2.4-1,3.3-.8,1-2.1,1.5-3.5,1.5ZM18,23.2l-10.9,1.9c-1.3.3-2.9,1.2-3.1,2.7l-.2,1.3c-.1.8.1,1.5.6,2.1.6.6,1.4,1,2.4,1h22.9c.8,0,1.5-.4,2-1,.5-.6.7-1.3.6-2.1l-.2-1.3c-.3-1.8-2.3-2.5-3.2-2.7l-10.9-1.9ZM18,18.8c-2.2,0-4.3-.9-5.8-2.4s-2.4-3.6-2.4-5.8.9-4.3,2.4-5.8c1.6-1.6,3.6-2.4,5.8-2.4s4.3.9,5.8,2.4c1.6,1.6,2.4,3.6,2.4,5.8s-.9,4.3-2.4,5.8c-1.6,1.6-3.6,2.4-5.8,2.4ZM18,3.8c-1.8,0-3.5.7-4.8,2-1.3,1.3-2,3-2,4.8s.7,3.5,2,4.8,3,2,4.8,2,3.5-.7,4.8-2c1.3-1.3,2-3,2-4.8s-.7-3.5-2-4.8c-1.3-1.3-3-2-4.8-2Z" />
                </svg>
            </div>
            <div class="user-dropdown">
                <div class="dropdown-item" data-action="login">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Entrar</span>
                </div>
                <div class="dropdown-item" data-action="cadastro">
                    <i class="fas fa-user-plus"></i>
                    <span>Cadastrar</span>
                </div>
                <div class="dropdown-item" data-action="perfil">
                    <i class="fas fa-user"></i>
                    <span>Meu perfil</span>
                </div>
                <div class="dropdown-item" data-action="logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Deslogar</span>
                </div>
            </div>
        </div>
    </header>

    <main>
        <main class="container">
            <div class="form-container">
                <div class="text">
                    <h1>Area do login</h1>
                    <p>Suas informações para o cadastro</p>
                </div>
                <form id="loginForm" action="/login" method="POST">
                    <input type="email" name="email" placeholder="Digite seu email" required>
                    <input type="password" name="senha" placeholder="Digite sua senha" required>
                    <button type="submit">Logar</button>
                </form>
                <p class="cont">Ainda não possui uma conta? Clique aqui!!</p>
            </div>
        </main>
    </main>

    <script>

        // Menu dropdown do usuário
        const userIcon = document.querySelector('.user-icon-wrapper');
        const userDropdown = document.querySelector('.user-dropdown');

        // Abrir/fechar dropdown
        userIcon.addEventListener('click', function (e) {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function () {
            userDropdown.classList.remove('active');
        });

        // Prevenir fechamento ao clicar dentro do dropdown
        userDropdown.addEventListener('click', function (e) {
            e.stopPropagation();
        });

        // Ações do dropdown
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', async function () {
                const action = this.getAttribute('data-action');

                if (action === "login") {
                    window.location.href = "/login";
                } else if (action === "cadastro") {
                    window.location.href = "/cadastrar";
                } else if (action === "logout") {
                    window.location.href = "/logout";
                } else if (action === "perfil") {
                    try {
                        const resposta = await fetch('/obterusuario');
                        if (resposta.ok) {
                            window.location.href = "/perfil";
                        } else {
                            window.location.href = "/login";
                        }
                    } catch (erro) {
                        console.error("Erro ao verificar autenticação:", erro);
                        window.location.href = "/login";
                    }
                }

                // Fechar dropdown após seleção
                userDropdown.classList.remove('active');
            });

        })
        // --- Navegação ---
        document.querySelector('.logo').addEventListener('click', () => {
            window.location.href = "/";
        });
        document.querySelector('.cont').addEventListener('click', () => {
            window.location.href = "/cadastrar";
        });

        const listItems = document.getElementsByTagName('li');
        for (let i = 0; i < listItems.length; i++) {
            listItems[i].addEventListener('click', function (event) {
                const text = event.target.textContent;

                if (text === "Quem somos") window.location.href = "/sobre";
                else if (text === "Ideias de Reciclagem") window.location.href = "/cadastroideia";
                else if (text === "Empresas cadastradas") window.location.href = "/cadastroempresa";
                else if (text === "Contato") window.location.href = "/contato";
            });
        }




        const loginForm = document.getElementById("loginForm");
        const inputs = loginForm.querySelectorAll("input");

        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();

            const formData = new FormData(loginForm);
            const dados = Object.fromEntries(formData.entries());

            try {
                const res = await fetch("/login", {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(dados)
                });

                if (res.redirected) {

                    window.location.href = res.url;
                } else if (!res.ok) {

                    inputs.forEach(input => input.classList.add("input-error"));

                    Swal.fire({
                        icon: 'error',
                        title: 'Email ou senha inválidos',
                        showConfirmButton: false,
                        timer: 3000
                    }).then(() => {

                        inputs.forEach(input => input.classList.remove("input-error"));
                    });
                }
            } catch (err) {
                Swal.fire({
                    icon: 'error',
                    title: 'Erro de conexão',
                    text: 'Não foi possível conectar ao servidor',
                    showConfirmButton: false,
                    timer: 2000
                });
            }
        });
    </script>
</body>

</html>