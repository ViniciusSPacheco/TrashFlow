<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ideias de Reciclagem - TrashFlow</title>
    <link rel="stylesheet" href="public/css/cadastroideia.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header>
        <div class="logo">
            <img src="./public/TrashflowLogo 2.png" alt="Logo TrashFlow">
        </div>
        <div class="navbar">
            <ul>
                <li>Quem somos</li>
                <li>Ideias de Reciclagem</li>
                <li>Empresas cadastradas</li>
                <li>Contato</li>
            </ul>
        </div>

        <div class="user-menu-container">
            <div class="user-icon-wrapper">
                <svg width="56" height="56" viewBox="0 0 36 36" fill="#4a9c0d" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M29.3,33.8h-2,0s-20.6,0-20.6,0c-1.4,0-2.6-.5-3.5-1.5-.8-.9-1.1-2.1-1-3.3l.2-1.3c.3-1.9,2-3.4,4.3-4l11.4-1.9h0s10.9,1.9,10.9,1.9c2.5.6,4,2,4.4,3.9l.2,1.3c.2,1.2-.2,2.4-1,3.3-.8,1-2.1,1.5-3.5,1.5ZM18,23.2l-10.9,1.9c-1.3.3-2.9,1.2-3.1,2.7l-.2,1.3c-.1.8.1,1.5.6,2.1.6.6,1.4,1,2.4,1h22.9c.8,0,1.5-.4,2-1,.5-.6.7-1.3.6-2.1l-.2-1.3c-.3-1.8-2.3-2.5-3.2-2.7l-10.9-1.9ZM18,18.8c-2.2,0-4.3-.9-5.8-2.4s-2.4-3.6-2.4-5.8.9-4.3,2.4-5.8c1.6-1.6,3.6-2.4,5.8-2.4s4.3.9,5.8,2.4c1.6,1.6,2.4,3.6,2.4,5.8s-.9,4.3-2.4,5.8c-1.6,1.6-3.6,2.4-5.8,2.4ZM18,3.8c-1.8,0-3.5.7-4.8,2-1.3,1.3-2,3-2,4.8s.7,3.5,2,4.8,3,2,4.8,2,3.5-.7,4.8-2c1.3-1.3,2-3,2-4.8s-.7-3.5-2-4.8c-1.3-1.3-3-2-4.8-2Z" />
                </svg>
            </div>
            <div class="user-dropdown">
                <div class="dropdown-item" data-action="login">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Entrar</span>
                </div>
                <div class="dropdown-item" data-action="cadastro">
                    <i class="fas fa-user-plus"></i>
                    <span>Cadastrar</span>
                </div>
                <div class="dropdown-item" data-action="perfil">
                    <i class="fas fa-user"></i>
                    <span>Meu perfil</span>
                </div>
                <div class="dropdown-item" data-action="logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Deslogar</span>
                </div>
            </div>
        </div>
    </header>

    <!-- Banner com Swiper -->
    <div class="swiper swiper-banner">
        <div class="swiper-wrapper">
            <div class="swiper-slide">
                <img src="https://images.unsplash.com/photo-1542601906990-b4d3fb778b09?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80"
                    alt="Reciclagem criativa">
                <div class="slide-content">
                    <h2>Transforme seu lixo em luxo</h2>
                    <p>Descubra centenas de ideias criativas para reutilizar materiais e reduzir o desperdício.</p>
                    <button class="slide-btn">Explorar ideias <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            <div class="swiper-slide">
                <img src="https://images.unsplash.com/photo-1493246507139-91e8fad9978e?ixlib=rb-4.0.3&auto=format&fit=crop&w=1600&q=80"
                    alt="Reciclagem de plástico">
                <div class="slide-content">
                    <h2>Ideias para reciclar plástico</h2>
                    <p>Aprenda a transformar garrafas plásticas em objetos úteis e decorativos para sua casa.</p>
                    <button class="slide-btn">Ver ideias <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
            <div class="swiper-slide">
                <img src="https://culturanf.com.br/wp-content/uploads/2023/12/fotografia-tecnicas-arte-papel-crepe.webp"
                    alt="Reciclagem de papel">
                <div class="slide-content">
                    <h2>Arte com papel reciclado</h2>
                    <p>Descubra como transformar jornais e revistas antigas em belas peças de arte.</p>
                    <button class="slide-btn">Inspirar-me <i class="fas fa-arrow-right"></i></button>
                </div>
            </div>
        </div>

        <div class="swiper-button-next"></div>
        <div class="swiper-button-prev"></div>
        <div class="swiper-pagination"></div>
    </div>

    <main class="container">
        <!-- Seção de busca moderna -->
        <div class="search-hero">
            <h1>Encontre ideias sustentáveis</h1>
            <p>Busque por materiais específicos ou explore nossas categorias para descobrir como transformar resíduos em
                recursos valiosos.</p>

            <div class="search-container-modern">
                <div class="search-box">
                    <input type="text" class="search-input-modern"
                        placeholder="Digite o material que deseja reciclar..." id="search-input">
                    <button class="search-btn">
                        <i class="fas fa-search"></i> Buscar
                    </button>
                </div>


            </div>
        </div>

        <div class="conteudos">
            <div class="header-section">
                <h1>Ideias para você reutilizar seu material</h1>
                <button class="add-idea-btn">
                    Quero adicionar uma ideia <i class="fas fa-plus"></i>
                </button>
            </div>

            <div class="ideas-grid" id="cards-container">
                <div class="loading-spinner">
                    <div class="spinner"></div>
                </div>
            </div>
        </div>
    </main>

    <!-- Modal para o passo a passo -->
    <div class="modal-overlay" id="modal-overlay">
        <div class="modal">
            <div class="modal-header">
                <h2 id="modal-title">Título da Ideia</h2>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="steps-container" id="steps-container">
                    <!-- Passos serão inseridos dinamicamente -->
                </div>
            </div>
            <div class="modal-footer">
                <button class="close-btn">Fechar</button>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <div class="footer-logo">
                <img src="./public/TrashflowLogo 2.png" alt="Trashflow Logo" width="100">
                <p>Transformando resíduos em oportunidades desde 2020.</p>
            </div>
            <div class="footer-links">
                <h4>Links Rápidos</h4>
                <ul>
                    <li><a href="#">Quem somos</a></li>
                    <li><a href="#">Ideias de Reciclagem</a></li>
                    <li><a href="#">Empresas cadastradas</a></li>
                    <li><a href="#">Contato</a></li>
                </ul>
            </div>
            <div class="footer-contact">
                <h4>Contato</h4>
                <p>contato@trashflow.com.br</p>
                <p>(11) 98765-4321</p>
                <div class="social-icons">
                    <a href="#"><i class="fab fa-facebook-f"></i></a>
                    <a href="#"><i class="fab fa-twitter"></i></a>
                    <a href="#"><i class="fab fa-instagram"></i></a>
                    <a href="#"><i class="fab fa-linkedin-in"></i></a>
                </div>
            </div>
        </div>
        <div class="footer-bottom">
            <p>&copy; 2023 Trashflow. Todos os direitos reservados.</p>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.js"></script>
    <script>

        // Menu dropdown do usuário
        const userIcon = document.querySelector('.user-icon-wrapper');
        const userDropdown = document.querySelector('.user-dropdown');

        // Abrir/fechar dropdown
        userIcon.addEventListener('click', function (e) {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function () {
            userDropdown.classList.remove('active');
        });

        // Prevenir fechamento ao clicar dentro do dropdown
        userDropdown.addEventListener('click', function (e) {
            e.stopPropagation();
        });

        // Ações do dropdown
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', async function () {
                const action = this.getAttribute('data-action');

                if (action === "login") {
                    window.location.href = "/login";
                } else if (action === "cadastro") {
                    window.location.href = "/cadastrar";
                } else if (action === "logout") {
                    window.location.href = "/logout";
                } else if (action === "perfil") {
                    try {
                        const resposta = await fetch('/obterusuario');
                        if (resposta.ok) {
                            window.location.href = "/perfil";
                        } else {
                            window.location.href = "/login";
                        }
                    } catch (erro) {
                        console.error("Erro ao verificar autenticação:", erro);
                        window.location.href = "/login";
                    }
                }

                // Fechar dropdown após seleção
                userDropdown.classList.remove('active');
            });

        })
        // Inicialização do Swiper do banner
        document.addEventListener('DOMContentLoaded', function () {

            const bannerSwiper = new Swiper('.swiper-banner', {
                loop: true,
                autoplay: {
                    delay: 5000,
                    disableOnInteraction: false,
                },
                pagination: {
                    el: '.swiper-pagination',
                    clickable: true,
                },
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                effect: 'fade',
                fadeEffect: {
                    crossFade: true
                },
            });

            // Navegação do menu
            const listItems = document.getElementsByTagName('li');
            for (let i = 0; i < listItems.length; i++) {
                listItems[i].addEventListener('click', function (event) {
                    const text = event.target.textContent;
                    if (text === "Quem somos") {
                        window.location.href = "/sobre";
                    } else if (text === "Ideias de Reciclagem") {
                        window.location.href = "/cadastroideia";
                    } else if (text === "Empresas cadastradas") {
                        window.location.href = "/cadastroempresa";
                    } else if (text === "Contato") {
                        window.location.href = "/contato";
                    }
                });
            }



            // Modal functions
            const modal = document.getElementById('modal-overlay');
            const closeModalBtn = document.querySelector('.close-modal');
            const closeBtn = document.querySelector('.close-btn');

            function openModal(title, steps) {
                document.getElementById('modal-title').textContent = title;

                const stepsContainer = document.getElementById('steps-container');
                stepsContainer.innerHTML = '';

                const stepsArray = steps.split('\n').filter(step => step.trim() !== '');

                stepsArray.forEach((step, index) => {
                    const stepElement = document.createElement('div');
                    stepElement.className = 'step';
                    stepElement.innerHTML = `
                        <div class="step-number">${index + 1}</div>
                        <div class="step-content">${step}</div>
                    `;
                    stepsContainer.appendChild(stepElement);
                });

                modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }

            function closeModal() {
                modal.style.display = 'none';
                document.body.style.overflow = 'auto';
            }

            closeModalBtn.addEventListener('click', closeModal);
            closeBtn.addEventListener('click', closeModal);
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeModal();
                }
            });

            document.querySelector('.logo').addEventListener('click', () => {
                window.location.href = "/";
            });

            // Filtros e busca
            const searchInput = document.getElementById('search-input');
            const categoryButtons = document.querySelectorAll('.filter-chip');
            let allIdeas = [];
            let currentCategory = 'all';
            let currentSearch = '';

            // Função para filtrar as ideias
            function filterIdeas() {
                const cardsContainer = document.getElementById('cards-container');
                const filteredIdeas = allIdeas.filter(idea => {
                    const matchesCategory = currentCategory === 'all' ||
                        (idea.material && idea.material.includes(currentCategory));

                    const matchesSearch = currentSearch === '' ||
                        idea.titulo.toLowerCase().includes(currentSearch) ||
                        idea.descricao.toLowerCase().includes(currentSearch) ||
                        (idea.material && idea.material.toLowerCase().includes(currentSearch));

                    return matchesCategory && matchesSearch;
                });

                displayIdeas(filteredIdeas);
            }

            // Event listeners para filtros
            searchInput.addEventListener('input', (e) => {
                currentSearch = e.target.value.toLowerCase();
                filterIdeas();
            });



            categoryButtons.forEach(button => {
                button.addEventListener('click', () => {
                    categoryButtons.forEach(btn => btn.classList.remove('active'));
                    button.classList.add('active');
                    currentCategory = button.dataset.category;
                    filterIdeas();
                });
            });

            // Função para extrair ID do YouTube
            function getYouTubeId(url) {
                if (!url) return null;

                const regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#&?]*).*/;
                const match = url.match(regExp);
                return (match && match[7].length === 11) ? match[7] : null;
            }

            // Função para exibir as ideias
            function displayIdeas(ideas) {
                const cardsContainer = document.getElementById('cards-container');

                if (ideas.length === 0) {
                    cardsContainer.innerHTML = `
                        <div class="no-results">
                            <i class="fas fa-search"></i>
                            <p>Nenhuma ideia encontrada. Tente alterar os filtros de busca.</p>
                        </div>
                    `;
                    return;
                }

                cardsContainer.innerHTML = '';

                ideas.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'idea-card';

                    const youtubeId = getYouTubeId(item.url);
                    const hasImage = item.img && item.img !== '/imagens/null';
                    const hasVideo = youtubeId !== null;

                    // Conteúdo do media (imagem ou vídeo)
                    let mediaContent = '';
                    if (hasVideo && hasImage) {
                        // Carrossel com vídeo e imagem
                        mediaContent = `
                            <div class="idea-media-carousel swiper">
                                <div class="swiper-wrapper">
                                    <div class="swiper-slide">
                                        <div class="video-container">
                                            <iframe src="https://www.youtube.com/embed/${youtubeId}" 
                                                    frameborder="0" 
                                                    allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                                    allowfullscreen>
                                            </iframe>
                                        </div>
                                    </div>
                                    <div class="swiper-slide">
                                        <img src="${item.img}" alt="${item.titulo}" class="idea-image">
                                    </div>
                                </div>
                                <div class="swiper-pagination"></div>
                                <div class="swiper-button-next"></div>
                                <div class="swiper-button-prev"></div>
                            </div>
                        `;
                    } else if (hasVideo) {
                        // Apenas vídeo
                        mediaContent = `
                            <div class="video-container">
                                <iframe src="https://www.youtube.com/embed/${youtubeId}" 
                                        frameborder="0" 
                                        allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" 
                                        allowfullscreen>
                                </iframe>
                            </div>
                        `;
                    } else if (hasImage) {
                        // Apenas imagem
                        mediaContent = `<img src="${item.img}" alt="${item.titulo}" class="idea-image">`;
                    } else {
                        // Imagem padrão
                        mediaContent = `<div class="no-media">
                            <i class="fas fa-recycle"></i>
                            <p>Imagem não disponível</p>
                        </div>`;
                    }

                    card.innerHTML = `
                        <div class="idea-media">
                            ${mediaContent}
                        </div>
                        <div class="idea-content">
                            <h3 class="idea-title">${item.titulo}</h3>
                            <p class="idea-desc">${item.descricao}</p>
                            <div class="idea-footer">
                                <span class="material-tag">${item.material || 'Vários materiais'}</span>
                                <button class="idea-btn">
                                    Ver passo a passo <i class="fas fa-arrow-right"></i>
                                </button>
                            </div>
                        </div>
                    `;

                    cardsContainer.appendChild(card);

                    // Inicializar Swiper se houver carrossel
                    if (hasVideo && hasImage) {
                        const carouselElement = card.querySelector('.idea-media-carousel');
                        new Swiper(carouselElement, {
                            loop: true,
                            pagination: {
                                el: carouselElement.querySelector('.swiper-pagination'),
                                clickable: true,
                            },
                            navigation: {
                                nextEl: carouselElement.querySelector('.swiper-button-next'),
                                prevEl: carouselElement.querySelector('.swiper-button-prev'),
                            },
                        });
                    }

                    // Adiciona evento de clique ao botão
                    const btn = card.querySelector('.idea-btn');
                    btn.addEventListener('click', () => {
                        openModal(item.titulo, item.passo);
                    });
                });
            }

            // Carrega os dados da API
            fetch('http://localhost:3030/dataideia')
                .then(response => response.json())
                .then(data => {
                    allIdeas = data;
                    displayIdeas(allIdeas);
                })
                .catch(error => {
                    console.error('Erro ao carregar dados da API:', error);
                    const cardsContainer = document.getElementById('cards-container');
                    cardsContainer.innerHTML = `
                        <div class="error-message">
                            <i class="fas fa-exclamation-triangle"></i>
                            <p>Não foi possível carregar as ideias no momento.</p>
                        </div>
                    `;
                });

            function getCookie(nome) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${nome}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            // Botão para adicionar nova ideia
            const addButton = document.querySelector('.add-idea-btn');
            addButton.addEventListener('click', () => {
                const cookie = getCookie("permissao");
                if (cookie) {
                    window.location.href = "/cadastroideiaform";
                } else {
                    alert("Você precisa estar logado para adicionar uma ideia.");
                    window.location.href = "/login";
                }
            });
        });



        const searchBtn = document.querySelector('.search-btn');
        searchBtn.addEventListener('click', () => {
            const conteudosSection = document.querySelector('.conteudos');
            if (conteudosSection) {
                conteudosSection.scrollIntoView({ behavior: 'smooth' });
            }
        });
    </script>
</body>

</html>