<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="utf-8" />
    <title>Meu Perfil | TrashFlow</title>
    <link rel="stylesheet" href="./public/css/usuario.css" />
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>

<body>
    <header>
        <div class="logo"><img src="./public/TrashflowLogo 2.png" alt="logo" /></div>
        <div class="navbar">
            <ul>
                <li>Quem somos</li>
                <li>Ideias de Reciclagem</li>
                <li>Empresas cadastradas</li>
                <li>Contato</li>
            </ul>
        </div>
        <div class="user-menu-container">
            <div class="user-icon-wrapper">
                <svg width="56" height="56" viewBox="0 0 36 36" fill="#4a9c0d" xmlns="http://www.w3.org/2000/svg">
                    <path
                        d="M29.3,33.8h-2,0s-20.6,0-20.6,0c-1.4,0-2.6-.5-3.5-1.5-.8-.9-1.1-2.1-1-3.3l.2-1.3c.3-1.9,2-3.4,4.3-4l11.4-1.9h0s10.9,1.9,10.9,1.9c2.5.6,4,2,4.4,3.9l.2,1.3c.2,1.2-.2,2.4-1,3.3-.8,1-2.1,1.5-3.5,1.5ZM18,23.2l-10.9,1.9c-1.3.3-2.9,1.2-3.1,2.7l-.2,1.3c-.1.8.1,1.5.6,2.1.6.6,1.4,1,2.4,1h22.9c.8,0,1.5-.4,2-1,.5-.6.7-1.3.6-2.1l-.2-1.3c-.3-1.8-2.3-2.5-3.2-2.7l-10.9-1.9ZM18,18.8c-2.2,0-4.3-.9-5.8-2.4s-2.4-3.6-2.4-5.8.9-4.3,2.4-5.8c1.6-1.6,3.6-2.4,5.8-2.4s4.3.9,5.8,2.4c1.6,1.6,2.4,3.6,2.4,5.8s-.9,4.3-2.4,5.8c-1.6,1.6-3.6,2.4-5.8,2.4ZM18,3.8c-1.8,0-3.5.7-4.8,2-1.3,1.3-2,3-2,4.8s.7,3.5,2,4.8,3,2,4.8,2,3.5-.7,4.8-2c1.3-1.3,2-3,2-4.8s-.7-3.5-2-4.8c-1.3-1.3-3-2-4.8-2Z" />
                </svg>
            </div>
            <div class="user-dropdown">
                <div class="dropdown-item" data-action="login">
                    <i class="fas fa-sign-in-alt"></i>
                    <span>Entrar</span>
                </div>
                <div class="dropdown-item" data-action="cadastro">
                    <i class="fas fa-user-plus"></i>
                    <span>Cadastrar</span>
                </div>
                <div class="dropdown-item" data-action="perfil">
                    <i class="fas fa-user"></i>
                    <span>Meu perfil</span>
                </div>
                <div class="dropdown-item" data-action="logout">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Deslogar</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="profile-header">
            <h1><i class="fas fa-user-circle"></i> Meu Perfil</h1>
            <p>Gerencie suas informações e registros</p>
        </div>

        <div class="profile-content">
            <div class="profile-sidebar">
                <div class="user-card">
                    <div class="user-avatar"><i class="fas fa-user"></i></div>
                    <div class="user-details">
                        <h3>Suas Informações</h3>
                        <p><strong>Nome:</strong> <span id="nome-atual">Carregando...</span></p>
                        <p><strong>Email:</strong> <span id="email-atual">Carregando...</span></p>
                    </div>
                </div>

                <div class="stats-card">
                    <h3>Estatísticas</h3>
                    <div class="stat-item"><i class="fas fa-lightbulb"></i><span id="ideias-count">0</span>
                        <p>Ideias Cadastradas</p>
                    </div>
                    <div class="stat-item"><i class="fas fa-building"></i><span id="empresas-count">0</span>
                        <p>Empresas Cadastradas</p>
                    </div>
                </div>
            </div>

            <div class="profile-main">
                <div class="form-section">
                    <h2><i class="fas fa-edit"></i> Atualizar Informações Pessoais</h2>
                    <form action="/atualizarusuario" method="POST" class="update-form">
                        <div class="form-group">
                            <label for="nome">Nome Completo</label>
                            <input type="text" id="nome" name="nome" required placeholder="Digite seu nome completo" />
                        </div>

                        <div class="form-group">
                            <label for="email">Email</label>
                            <input type="email" id="email" name="email" required placeholder="seu.email@exemplo.com" />
                        </div>

                        <div class="form-group">
                            <label for="senha">Nova Senha</label>
                            <input type="password" id="senha" name="senha" placeholder="Digite sua nova senha" />
                            <small>Deixe em branco se não deseja alterar</small>
                        </div>

                        <button type="submit" class="submit-btn"><i class="fas fa-sync-alt"></i> Atualizar
                            Dados</button>
                    </form>
                </div>

                <!-- somente empresas -->
                <div class="form-section" id="empresa-section" style="display:none;">
                    <h2><i class="fas fa-building"></i> Atualizar Dados da Empresa</h2>
                    <form class="update-empresa-form" action="/atualizarempresa" method="POST">
                        <div class="form-group">
                            <label for="empresa-nome">Nome da Empresa *</label>
                            <input type="text" id="empresa-nome" name="nome" required>
                        </div>

                        <div class="form-group">
                            <label for="empresa-cnpj">CNPJ *</label>
                            <input type="text" id="empresa-cnpj" name="cnpj" required>
                        </div>

                        <div class="form-group">
                            <label>Materiais Recolhidos *</label>
                            <div class="checkbox-group">
                                <div class="checkbox-row">
                                    <label><input type="checkbox" name="material" value="Plástico"> Plástico</label>
                                    <label><input type="checkbox" name="material" value="Papel"> Papel</label>
                                    <label><input type="checkbox" name="material" value="Vidro"> Vidro</label>
                                </div>
                                <div class="checkbox-row">
                                    <label><input type="checkbox" name="material" value="Metal"> Metal</label>
                                    <label><input type="checkbox" name="material" value="Orgânico"> Orgânico</label>
                                    <label><input type="checkbox" name="material" value="Eletrônicos">
                                        Eletrônicos</label>
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="empresa-endereco">Endereço *</label>
                            <input type="text" id="empresa-endereco" name="endereco" required>
                        </div>

                        <div class="form-group">
                            <label for="empresa-telefone">Telefone</label>
                            <input type="text" id="empresa-telefone" name="telefone">
                        </div>

                        <div class="form-group">
                            <label for="empresa-horario">Horário de Funcionamento</label>
                            <input type="text" id="empresa-horario" name="horario_funcionamento"
                                placeholder="Ex: Segunda a Sexta, 8h às 18h">
                        </div>

                        <button type="submit" class="submit-btn"><i class="fas fa-sync-alt"></i> Atualizar Dados da
                            Empresa</button>
                    </form>
                </div>

                <div class="registries-section">
                    <h2><i class="fas fa-history"></i> Seus Registros</h2>
                    <div class="registries-container" id="registries-container">
                        <div class="loading"><i class="fas fa-spinner fa-spin"></i>
                            <p>Carregando seus registros...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- modal -->
    <div class="modal" id="confirmationModal" style="display:none;">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h3><i class="fas fa-exclamation-triangle"></i> Confirmar Exclusão</h3>
            <p>Tem certeza que deseja excluir este registro? Esta ação não pode ser desfeita.</p>
            <div class="modal-buttons">
                <button class="modal-btn cancel-btn">Cancelar</button>
                <button class="modal-btn confirm-btn">Confirmar</button>
            </div>
        </div>
    </div>

    <script>
        document.querySelector('.logo').addEventListener('click', () => window.location.href = '/');


        const modal = document.getElementById('confirmationModal');
        const closeModal = document.querySelector('.close-modal');
        const cancelBtn = document.querySelector('.cancel-btn');
        const confirmBtn = document.querySelector('.confirm-btn');
        let currentDelete = null;

        function openModal() { modal.style.display = 'block'; document.body.style.overflow = 'hidden' }
        function closeModalFunc() { modal.style.display = 'none'; document.body.style.overflow = 'auto'; currentDelete = null }

        closeModal?.addEventListener('click', closeModalFunc);
        cancelBtn?.addEventListener('click', closeModalFunc);
        window.addEventListener('click', (e) => { if (e.target === modal) closeModalFunc(); });

        async function carregarDadosUsuario() {
            try {
                const r = await fetch('/obterusuario');
                if (!r.ok) throw new Error('não autorizado');
                const usuario = await r.json();

                document.getElementById("nome-atual").textContent = usuario.nome;
                document.getElementById("email-atual").textContent = usuario.email;
                document.getElementById("nome").value = usuario.nome;
                document.getElementById("email").value = usuario.email;

                // se for empresa
                if (usuario.tipo === "empresa") {
                    document.getElementById("empresa-section").style.display = "block";
                    await carregarDadosEmpresa();
                }

                carregarRegistros();
            } catch (err) {
                console.error(err);
                alert('Erro ao carregar usuário — faça login novamente.');
                window.location.href = '/login';
            }
        }

        async function carregarDadosEmpresa() {
            try {
                const r = await fetch('/obterempresa');
                if (!r.ok) return;
                const empresa = await r.json();
                if (!empresa || Object.keys(empresa).length === 0) return;

                // preencher campos
                if (empresa.nome) document.getElementById("empresa-nome").value = empresa.nome;
                if (empresa.cnpj) document.getElementById("empresa-cnpj").value = empresa.cnpj;
                if (empresa.endereco) document.getElementById("empresa-endereco").value = empresa.endereco;
                if (empresa.telefone) document.getElementById("empresa-telefone").value = empresa.telefone;
                if (empresa.horario_funcionamento) document.getElementById("empresa-horario").value = empresa.horario_funcionamento;

                // materiais (string separada por vírgula no banco)
                if (empresa.material) {
                    const arr = typeof empresa.material === 'string' ? empresa.material.split(',').map(s => s.trim()) : empresa.material;
                    document.querySelectorAll('input[name="material"]').forEach(cb => {
                        if (arr.includes(cb.value)) cb.checked = true;
                    });
                }
            } catch (err) {
                console.error('Erro ao obter empresa:', err);
            }
        }

        async function carregarRegistros() {
            try {
                const rIdeias = await fetch('/obterideias');
                const rEmpresas = await fetch('/obterempresas');
                const ideias = await rIdeias.json();
                const empresas = await rEmpresas.json();

                const container = document.getElementById('registries-container');
                container.innerHTML = '';
                document.getElementById('ideias-count').textContent = ideias.length;
                document.getElementById('empresas-count').textContent = empresas.length;

                if (ideias.length === 0 && empresas.length === 0) {
                    container.innerHTML = `<div class="empty-state"><i class="fas fa-inbox"></i><p>Nenhum registro encontrado.</p></div>`;
                    return;
                }

                if (ideias.length > 0) {
                    const s = document.createElement('div'); s.classList.add('registry-section');
                    s.innerHTML = `<h4><i class="fas fa-lightbulb"></i> Ideias Cadastradas</h4>`;
                    ideias.forEach(idea => {
                        const div = document.createElement('div'); div.classList.add('registry-item');
                        // use ideia.id (campo padrão)
                        const id = idea.id || idea.cod || idea.ID;
                        div.innerHTML = `
              <div class="registry-info">
                <h5>${idea.titulo}</h5>
                <p>${(idea.descricao || '').substring(0, 60)}...</p>
                <span class="registry-date">Criado em: ${new Date(idea.dataCriacao || Date.now()).toLocaleDateString('pt-BR')}</span>
              </div>
              <button class="delete-btn" data-tipo="ideia" data-id="${id}"><i class="fas fa-trash"></i></button>
            `;
                        s.appendChild(div);
                    });
                    container.appendChild(s);
                }

                if (empresas.length > 0) {
                    const s = document.createElement('div'); s.classList.add('registry-section');
                    s.innerHTML = `<h4><i class="fas fa-building"></i> Empresas Cadastradas</h4>`;
                    empresas.forEach(emp => {
                        // USE 'cod' para empresa (PK)
                        const id = emp.cod || emp.id || emp.COD;
                        const div = document.createElement('div'); div.classList.add('registry-item');
                        div.innerHTML = `
              <div class="registry-info">
                <h5>${emp.nome}</h5>
                <p>${(emp.endereco ? emp.endereco.substring(0, 60) + '...' : 'Sem endereço cadastrado')}</p>
                <span class="registry-date">Cadastrado em: ${new Date(emp.dataCriacao || Date.now()).toLocaleDateString('pt-BR')}</span>
              </div>
              <button class="delete-btn" data-tipo="empresa" data-id="${id}"><i class="fas fa-trash"></i></button>
            `;
                        s.appendChild(div);
                    });
                    container.appendChild(s);
                }

                // eventos delete
                document.querySelectorAll('.delete-btn').forEach(btn => {
                    btn.addEventListener('click', function () {
                        currentDelete = this;
                        openModal();
                    });
                });

                // confirmar exclusão
                confirmBtn?.addEventListener('click', async () => {
                    if (!currentDelete) return;
                    const tipo = currentDelete.dataset.tipo;
                    const id = currentDelete.dataset.id;
                    try {
                        const res = await fetch(`/deletar/${tipo}/${id}`, { method: 'DELETE' });
                        if (res.ok) {
                            showNotification('Registro deletado com sucesso!', 'success');
                            await carregarRegistros();
                        } else {
                            const txt = await res.text();
                            console.error('Erro delete:', txt);
                            showNotification('Erro ao deletar registro!', 'error');
                        }
                    } catch (err) {
                        console.error(err);
                        showNotification('Erro ao deletar registro!', 'error');
                    }
                    closeModalFunc();
                });

            } catch (err) {
                console.error(err);
                document.getElementById('registries-container').innerHTML = `<div class="error-state"><p>Erro ao carregar registros.</p></div>`;
            }
        }

        function showNotification(message, type) {
            const n = document.createElement('div');
            n.className = `notification ${type}`;
            n.innerHTML = `<span>${message}</span>`;
            document.body.appendChild(n);
            setTimeout(() => n.classList.add('show'), 100);
            setTimeout(() => { n.classList.remove('show'); setTimeout(() => n.remove(), 300); }, 3000);
        }

        document.addEventListener('DOMContentLoaded', carregarDadosUsuario);

        // Menu dropdown do usuário
        const userIcon = document.querySelector('.user-icon-wrapper');
        const userDropdown = document.querySelector('.user-dropdown');

        // Abrir/fechar dropdown
        userIcon.addEventListener('click', function (e) {
            e.stopPropagation();
            userDropdown.classList.toggle('active');
        });

        // Fechar dropdown ao clicar fora
        document.addEventListener('click', function () {
            userDropdown.classList.remove('active');
        });

        // Prevenir fechamento ao clicar dentro do dropdown
        userDropdown.addEventListener('click', function (e) {
            e.stopPropagation();
        });

        // Ações do dropdown
        document.querySelectorAll('.dropdown-item').forEach(item => {
            item.addEventListener('click', async function () {
                const action = this.getAttribute('data-action');

                if (action === "login") {
                    window.location.href = "/login";
                } else if (action === "cadastro") {
                    window.location.href = "/cadastrar";
                } else if (action === "logout") {
                    window.location.href = "/logout";
                } else if (action === "perfil") {
                    try {
                        const resposta = await fetch('/obterusuario');
                        if (resposta.ok) {
                            window.location.href = "/perfil";
                        } else {
                            window.location.href = "/login";
                        }
                    } catch (erro) {
                        console.error("Erro ao verificar autenticação:", erro);
                        window.location.href = "/login";
                    }
                }

                // Fechar dropdown após seleção
                userDropdown.classList.remove('active');
            });

        })

        listItems[i].addEventListener('click', function (event) {
            const text = event.target.textContent;

            console.log(text);

            if (text === "Quem somos") {
                window.location.href = "/sobre";
            } else if (text === "Ideias de Reciclagem") {
                window.location.href = "/cadastroideia";
            } else if (text === "Empresas cadastradas") {
                window.location.href = "/cadastroempresa";
            } else if (text === "Contato") {
                window.location.href = "/contato";
            }
        });



    </script>
</body>

</html>